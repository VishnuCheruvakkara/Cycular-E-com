{% extends 'partials/base.html' %}
{% block title %}Cycular | Verify OTP{% endblock %}
{% load static %}

{% block content %}

{% include 'partials/loader.html' %}

<style>
    .otp-inputs {
        display: flex;
        justify-content: center;
        gap: 10px;
        max-width: 360px;
        margin: 20px auto;
    }

    .otp-input {
        width: 50px;
        height: 50px;
        text-align: center;
        font-size: 22px;
        border: 2px solid #ced4da;
        border-radius: 8px;
        background-color: #f8f9fa;
        transition: 0.2s;
    }

    .otp-input:focus {
        outline: none;
        border-color: #1cc0a0;
    }

    #otp-timer {
        font-size: 14px;
        font-weight: 600;
    }

    .swal-toast-title {
        font-size: 15px !important;
        font-weight: 600;
    }
</style>

<main class="main">
    <div class="container mt-5">
        <h3 class="text-center mb-3">Enter OTP</h3>

        <form method="POST">
            {% csrf_token %}

            <div class="otp-inputs">
                <input type="text" name="otp1" class="otp-input" maxlength="1" required>
                <input type="text" name="otp2" class="otp-input" maxlength="1" required>
                <input type="text" name="otp3" class="otp-input" maxlength="1" required>
                <input type="text" name="otp4" class="otp-input" maxlength="1" required>
                <input type="text" name="otp5" class="otp-input" maxlength="1" required>
                <input type="text" name="otp6" class="otp-input" maxlength="1" required>
            </div>

            <div class="text-center mb-3">
                Time remaining : <span id="otp-timer"></span>
            </div>

            <div class="d-flex flex-column align-items-center">
                <button type="submit" class="btn btn-primary mb-2">
                    Verify OTP
                </button>

                <a href="{% url 'user_side:resend-otp' %}"
                   id="resend-otp"
                   class="btn btn-link">
                    Resend OTP
                </a>
            </div>
        </form>
    </div>
</main>

<script src="{% static 'assets/js/jquery.min.js' %}"></script>
<script src="{% static 'assets/js/bootstrap.bundle.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {

   
    //    OTP TIMER (FIXED LOGIC)
    const TIMER_DURATION = 300; // 5 minutes
    const timerEl = document.getElementById("otp-timer");
    const resendBtn = document.getElementById("resend-otp");
    const loader = document.getElementById("global-loader");
    const inputs = document.querySelectorAll('.otp-input');
    let interval = null;

    resendBtn.style.display = "inline-block";

    function getRemainingTime() {
        const expiry = sessionStorage.getItem('otp_expiry');
        if (!expiry) return 0;
        return Math.max(0, Math.floor((expiry - Date.now()) / 1000));
    }

    function startTimer(seconds = TIMER_DURATION) {
        const expiryTime = Date.now() + seconds * 1000;
        sessionStorage.setItem('otp_expiry', expiryTime);
        clearInterval(interval);
        interval = setInterval(updateTimer, 1000);
        updateTimer();
    }

    function updateTimer() {
        const remaining = getRemainingTime();

        if (remaining <= 0) {
            clearInterval(interval);
            timerEl.innerText = "OTP expired";
            timerEl.style.color = "#1cc0a0";
            sessionStorage.removeItem('otp_expiry');
            return;
        }

        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        timerEl.innerText = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        timerEl.style.color = "#1cc0a0";
    }

    if (getRemainingTime() > 0) {
        interval = setInterval(updateTimer, 1000);
        updateTimer();
    } else {
        startTimer();
    }

    
    // OTP INPUT UX
    inputs.forEach((input, index) => {

        input.addEventListener('input', () => {
            input.value = input.value.replace(/[^0-9]/g, '');
            if (input.value && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
        });

        input.addEventListener('keydown', e => {
            if (e.key === "Backspace" && !input.value && index > 0) {
                inputs[index - 1].focus();
            }
        });

        input.addEventListener('paste', e => {
            e.preventDefault();
            const pasteData = e.clipboardData.getData('text').trim();
            if (!/^\d+$/.test(pasteData)) return;

            pasteData.split('').forEach((char, i) => {
                if (inputs[i]) inputs[i].value = char;
            });

            inputs[Math.min(pasteData.length, inputs.length) - 1]?.focus();
        });
    });

   
    //  RESEND OTP
    resendBtn.addEventListener('click', function (e) {
        e.preventDefault();
        loader.classList.remove('d-none');

        fetch(this.href, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => res.json())
        .then(data => {
            loader.classList.add('d-none');

            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: data.status,
                title: data.message,
                showConfirmButton: false,
                timer: 3500,
                customClass: { title: 'swal-toast-title' }
            });

            if (data.status === 'success') {
                startTimer();
            }
        })
        .catch(() => loader.classList.add('d-none'));
    });

});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    {% if messages %}
        {% for message in messages %}
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: '{{ message.tags }}',
                title: "{{ message }}",
                showConfirmButton: false,
                timer: 3500,
                customClass: { title: 'swal-toast-title' }
            });
        {% endfor %}
    {% endif %}
});
</script>

{% endblock %}
