{% extends 'partials/base.html' %}
{% block title %}Cycular Order history page{% endblock %}
{% load static %}

{% block content %}
<head>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- SweetAlert CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <style>
        /* Custom width for modal */
        .custom-modal-width .modal-dialog {
            max-width: 450px; /* Adjust as needed */
            margin: 30px auto; /* Adjust vertical margin if necessary */
        }
    </style>
    <!-- modal for invoice show -->
    <style>
    .modal-content {
        padding: 20px;
    }
    
    .modal-header {
        border-bottom: 1px solid #e9ecef;
    }
    
    .modal-footer {
        border-top: 1px solid #e9ecef;
    }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
</head>
<body>
        <main class="main mt-2 ">

            <div class="page-header text-center" style="background-image: url('{% static 'assets/images/page-header-bg.jpg' %}')">
        		<div class="container">
        			<h1 class="page-title">Order History<span>Overview</span></h1>
        		</div><!-- End .container -->
        	</div><!-- End .page-header -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <div class="row align-items-center">
                        <div class="col-auto">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item">
                                    <a href="{% url 'core:index' %}">Home</a>
                                </li>
                                <li class="breadcrumb-item">
                                    <a  href="{% url 'user_side:user-dash-board' %}" >My Account</a>
                                </li>
                                <li class="breadcrumb-item active" aria-current="page">Order History</li>
                            </ol>
                        </div>
                        <div class="col text-right">
                            <a href="{% url 'wallet:wallet-page' %}"  style=" cursor: pointer;">
                                Go to Wallet
                                <i class="bi bi-arrow-right ms-2 transition"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </nav>


            <main class="container text-center">

                <div class="success-message" style="margin-top: 0px;">
                    <h4 class="text-center">Pending Payments</h4>

                    {% if orders %}
                        {% for order in orders %}
                        <div class="order-section mb-4 p-3" style="border:1px solid #ddd; border-radius:5px;">

                            <h5 class="text-center mb-3">
                                Order #{{ order.id }} - {{ order.order_date }} - Total: {{ order.paid_amount }} ₹
                            </h5>

                            <div class="table-container">
                                <table class="table table-bordered responsive-table text-center align-middle">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="text-center">Sl No</th>
                                            <th class="text-center">Product</th>
                                            <th class="text-center">Qty</th>
                                            <th class="text-center">Payment Method</th>
                                            <th class="text-center">Status</th>
                                            <th class="text-center">Price</th>
                                            <th class="text-center">Action</th>
                                        </tr>
                                    </thead>

                                    <tbody>
                                        {% for item in order.items.all %}
                                        <tr>
                                            <td class="text-center align-middle">
                                                {{ forloop.counter }}
                                            </td>

                                            <td class="align-middle">
                                                <div class="d-flex justify-content-center align-items-center gap-2 text-center">
                                                    <a href="{% url 'products:single-product-view' item.product_variant.id %}">
                                                        <img src="{{ item.product_variant.image1.url }}"
                                                            alt="{{ item.product_variant.product.name }}"
                                                            class="img-thumbnail"
                                                            style="width:50px; height:50px;">
                                                    </a>

                                                    <div class="text-center">
                                                        <strong>{{ item.product_variant.product.name }}</strong>

                                                        <div style="font-size:13px;">
                                                            ({{ item.product_variant.color.name }} - {{ item.product_variant.size.name }})
                                                        </div>

                                                        {% with stock=item.product_variant.stock %}
                                                            {% if stock == 0 %}
                                                                <div style="color:red; font-size:13px; font-weight:600;">
                                                                    Out of stock
                                                                </div>

                                                            {% elif stock < item.quantity %}
                                                                <div style="color:red; font-size:13px; font-weight:600;">
                                                                    Only {{ stock }} left
                                                                </div>

                                                            {% elif stock < 5 %}
                                                                <div style="color:red; font-size:13px; font-weight:600;">
                                                                    Only {{ stock }} left
                                                                </div>
                                                            {% endif %}
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                            </td>

                                            <td class="text-center align-middle">
                                                {{ item.quantity }}
                                            </td>

                                            <td class="text-center align-middle">
                                                {{ order.get_payment_method_display }}
                                            </td>

                                            <td class="text-center align-middle">
                                                {{ item.order_item_status }}
                                            </td>

                                            <td class="text-center align-middle">
                                                {{ item.effective_price }} ₹
                                            </td>

                                            <td class="text-center align-middle">
                                                {% if item.order_item_status == 'Pending Payment' or item.order_item_status == 'Payment Failed' %}
                                                    {% if item.product_variant.stock >= item.quantity %}
                                                        <a href="{% url 'payment:razorpay-order-item' item.id %}"
                                                        class="btn btn-success btn-sm"
                                                        style="width:90px;">
                                                            Pay Now
                                                        </a>
                                                    {% else %}
                                                        <button
                                                            type="button"
                                                            class="btn btn-danger btn-sm"
                                                            style="width:90px;"
                                                            onclick="outOfStockAlert(
                                                                '{{ item.product_variant.product.name|escapejs }}',
                                                                {{ item.product_variant.stock }},
                                                                {{ item.quantity }}
                                                            )">
                                                            Not available
                                                        </button>
                                                    {% endif %}

                                                {% else %}
                                                    <span class="text-muted">N/A</span>
                                                {% endif %}
                                            </td>

                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% empty %}
                            <div class="alert alert-success text-center mt-3">
                                <strong>No pending payments found.</strong>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-success text-center mt-3">
                            <strong>No pending payments found.</strong>
                        </div>
                    {% endif %}
                </div>



                <div class="success-message" style="margin-top: 30px;">
                    <h4>Order History</h4>
                    <div class="table-container">
                        <table class="table responsive-table">
                            <thead>
                                <tr>
                                    <th>Sl No</th>
                                    <th>Product</th>
                                    <th>Payment Method</th>
                                    <th>Order Date</th>
                                    <th>Offer</th>
                                    <th>Coupon Info</th>
                                    <th>Actual Price</th>
                                    <th>Coupon Discount</th>
                                    <th>Paid</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                    <th>Invoice</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for order_item in order_items %}
                                {% if order_item.order.order_status != 'Payment Failed' %}
                                <tr>
                                    <td data-label="Sl No">{{ forloop.counter }}</td>
                                    <td data-label="Product" class="product-cell">
                                        <div class="product-info">
                                            <div class="product-image">
                                                <a href="{% url 'products:single-product-view' order_item.product_variant.id %}">
                                                    <img src="{{ order_item.product_variant.image1.url }}" alt="{{ order_item.product_variant.product.name }}">
                                                </a>
                                            </div>
                                            <div class="product-details">
                                                <strong>{{ order_item.product_variant.product.name }}</strong><br>
                                                <span class="quantity">(Qty.{{ order_item.quantity }})</span>
                                                <small class="variant-info">
                                                    ({{ order_item.product_variant.color.name }} - {{ order_item.product_variant.size.name }})
                                                </small>
                                            </div>
                                        </div>
                                    </td>
                                    <td data-label="Payment Method">{{ order_item.order.get_payment_method_display }}</td>
                                    <td data-label="Order Date">{{ order_item.order.order_date }}</td>
                                    <td data-label="Offer">
                                        {% if order_item.product_variant.get_discount_percentage > 0 %}
                                            Offer of {{ order_item.product_variant.get_discount_percentage }}%. You saved: {{ order_item.product_variant.get_savings_amount|floatformat:2}} ₹
                                        {% else %}
                                            No Offers Available
                                        {% endif %}
                                    </td>
                                    <td data-label="Coupon Info">
                                        {% if order_item.coupon_discount_price == 0 %}
                                            Coupon not applied
                                        {% else %}
                                            {{ order_item.coupon_info }}
                                        {% endif %}
                                    </td>
                                    <td data-label="Actual Price">{{ order_item.product_variant.price }} ₹</td>
                                    <td data-label="Coupon Discount">{{ order_item.coupon_discount_price }} ₹</td>
                                    <td data-label="Paid">{{ order_item.effective_price|floatformat:2 }} ₹</td>
                                    <td data-label="Status"><b>{{ order_item.order_item_status }}</b></td>
                                    <td data-label="Actions">
                                        {% if order_item.order_item_status == 'Order placed' or order_item.order_item_status == 'Processing' or order_item.order_item_status == 'Shipped' %}
                                            <button class="cancel-order-item-btn" data-url="{% url 'wallet:cancell-order-item' order_item.id %}">
                                                Cancel
                                            </button>
                                        {% elif order_item.order_item_status == 'Cancelled' %}
                                            <button class="cancelled-btn" disabled title="This product has already been cancelled">
                                                Cancelled
                                            </button>
                                        {% endif %}
                                        
                                        {% if order_item.order_item_status == 'Delivered' %}
                                            <button class="return-btn" data-order-item-id="{{ order_item.id }}">
                                                Return
                                            </button>
                                        {% elif order_item.order_item_status == 'Return Requested' %}
                                            <span class="return-requested">Requested</span>
                                        {% elif order_item.order_item_status == 'Returned' %}
                                            <span class="returned">Returned</span>
                                        {% endif %}
                                    </td>
                                    <td data-label="Invoice">
                                        <button class="invoice-btn" data-toggle="modal" data-target="#invoiceModal-{{ order_item.id }}">
                                            Invoice
                                        </button>
                                    </td>
                                </tr>
                                {% endif %}

                                
                                  <!-- Bootstrap Modal for invoice of each order item -->
                                  <div class="modal fade ml-4 mt-1" id="invoiceModal-{{ order_item.id }}" tabindex="-1" aria-labelledby="invoiceModalLabel-{{ order_item.id }}" aria-hidden="true">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="invoiceModalLabel-{{ order_item.id }}">Invoice for Order #{{ order_item.id }}</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <!-- Company Info at the top -->
                                                <div class="row mb-4 align-items-center">
                                                    <!-- Logo on the left -->
                                                    <div class="col-2">
                                                        <img src="{% static 'assets/images/cycular/cycular_black.png' %}" alt="Cycular Logo" class="img-fluid" style="width: 100px; height: auto;">
                                                    </div>
                                                    <!-- Name and Address on the right -->
                                                    <div class="col-10">
                                                        <h4 class="mb-0">Cycular</h4>
                                                        <p class="mb-0">123 Cycle St, City Name, State, Zip Code</p>
                                                    </div>
                                                </div>
                                
                                                <div class="row">
                                                    <!-- Product Image on the left -->
                                                    <div class="col-md-4">
                                                        <img src="{{ order_item.product_variant.image1.url }}" alt="{{ order_item.product_variant.product.name }}" class="img-fluid" style="max-height: 150px; object-fit: cover;">
                                                    </div>
                                                    <!-- Product Details on the right -->
                                                    <div class="col-md-8">
                                                        <div class="row">
                                                            <!-- Product Details Column -->
                                                            <div class="col-6 text-left">
                                                                <p><strong>Product:</strong></p>
                                                                <p><strong>Quantity:</strong></p>
                                                                <p><strong>Order Date:</strong></p>
                                                                <p><strong>Payment Method:</strong></p>
                                                                <p><strong>Status:</strong></p>
                                                                <p><strong>Actual Price:</strong></p>
                                                                <p><strong>Coupon Discount:</strong></p>
                                                                <p><strong>Offer Discount:</strong></p>
                                                            </div>
                                                            <!-- Product Values Column -->
                                                            <div class="col-6 text-left">
                                                                <p>{{ order_item.product_variant.product.name }}</p>
                                                                <p>{{ order_item.quantity }}</p>
                                                                <p>{{ order_item.order.order_date }}</p>
                                                                <p>{{ order_item.order.get_payment_method_display }}</p>
                                                                <p style="color: red; font-weight: bold;">
                                                                    {{ order_item.order_item_status }}
                                                                </p>
                                                                <p>{{ order_item.product_variant.price }} ₹</p>
                                                                <p>-{{ order_item.coupon_discount_price }} ₹</p>
                                                                <p>-{{ order_item.product_variant.get_savings_amount|floatformat:2 }} ₹</p>
                                                            </div>
                                                        </div>
                                                        <hr>
                                                        <div class="row">
                                                            <div class="col-6 text-left font-weight-bold">
                                                                <p>Total Amount:</p>
                                                            </div>
                                                            <div class="col-6 text-left font-weight-bold">
                                                                <p>{{ order_item.effective_price|floatformat:2 }} ₹</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <span class="text-muted">&copy; {{ current_year }} Cycular. All rights reserved.</span>
                                                <!-- Button to download the invoice -->
                                                <a href="{% url 'user_side:download-invoice-item' order_item.id %}" class="btn btn-primary download-invoice-button">Download Invoice</a>



                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                  </div>


                                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                                <script>
                                    document.querySelectorAll(".download-invoice-button").forEach(button => {
                                        button.addEventListener("click", function(e) {
                                            e.preventDefault();  // Prevent immediate navigation
                                
                                            let timerInterval;
                                            Swal.fire({
                                                title: "Invoice is downloading...",
                                                html: "Please wait...",
                                                timer: 3000,  // Set the time as per your preference (6 seconds here)
                                                width: "300px",
                                                timerProgressBar: true,
                                                didOpen: () => {
                                                    Swal.showLoading();
                                                },
                                                willClose: () => {
                                                    clearInterval(timerInterval);
                                                }
                                            }).then((result) => {
                                                if (result.dismiss === Swal.DismissReason.timer) {
                                                    // Redirect to download URL after the SweetAlert closes
                                                    const downloadUrl = this.href;  // Use the href of the clicked button
                                                    window.location.href = downloadUrl;
                                                }
                                            });
                                        });
                                    });
                                </script>
                                
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <style>
                .table-container {
                    overflow-x: auto;
                }
                .responsive-table {
                    width: 100%;
                    border-collapse: collapse;
                }
                .responsive-table th, .responsive-table td {
                    padding: 10px;
                    text-align: left;
                    border-bottom: 1px solid #ddd;
                }
                .responsive-table th {
                    background-color: #f2f2f2;
                    font-weight: bold;
                }
                .product-cell {
                    min-width: 250px;
                }
                .product-info {
                    display: flex;
                    align-items: center;
                }
                .product-image img {
                    width: 50px;
                    height: 50px;
                    object-fit: cover;
                    margin-right: 10px;
                }
                .product-details {
                    display: flex;
                    flex-direction: column;
                }
                .quantity {
                    color: #fd4f4f;
                    font-size: 10px;
                    font-weight: bold;
                }
                .variant-info {
                    color: #6c757d;
                }
                .cancel-order-item-btn, .invoice-btn {
                    width: 90px;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    padding: 5px 10px;
                    margin: 2px;
                    cursor: pointer;
                }
                .cancel-order-item-btn {
                    background-color: rgb(253, 79, 79);
                }
                .cancelled-btn {
                    width: 90px;
                    color: white;
                    background-color: gray;
                    border: none;
                    border-radius: 5px;
                    padding: 5px 10px;
                    margin: 2px;
                }
                .return-btn {
                    background-color: yellow;
                    border: none;
                    color: black;
                    cursor: pointer;
                    border-radius: 5px;
                    padding: 5px 10px;
                    margin: 2px;
                }
                .return-requested, .returned {
                    color: rgb(255, 255, 255);
                    padding: 5px 10px;
                    border-radius: 5px;
                    display: inline-block;
                    margin: 2px;
                }
                .return-requested {
                    background-color: gray;
                }
                .returned {
                    background-color: rgba(11, 165, 31, 0.79);
                }
                .invoice-btn {
                    background-color: rgb(79, 145, 253);
                }
                
                @media screen and (max-width: 768px) {
                    .responsive-table thead {
                        display: none;
                    }
                    .responsive-table, .responsive-table tbody, .responsive-table tr, .responsive-table td {
                        display: block;
                        width: 100%;
                    }
                    .responsive-table tr {
                        margin-bottom: 15px;
                        border: 1px solid #ddd;
                    }
                    .responsive-table td {
                        text-align: right;
                        padding-left: 50%;
                        position: relative;
                    }
                    .responsive-table td::before {
                        content: attr(data-label);
                        position: absolute;
                        left: 6px;
                        width: 45%;
                        padding-right: 10px;
                        white-space: nowrap;
                        text-align: left;
                        font-weight: bold;
                    }
                    .product-info {
                        flex-direction: row;
                        justify-content: flex-end;
                    }
                    .product-image {
                        order: 2;
                        margin-left: 10px;
                    }
                    .product-details {
                        order: 1;
                        text-align: right;
                    }
                }
                </style>









                
                
            </main>
            

            <!-- Include SweetAlert CSS and JS in your HTML -->
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
            
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const returnButtons = document.querySelectorAll('.return-btn');
            
                    returnButtons.forEach(button => {
                        button.addEventListener('click', function(event) {
                            event.preventDefault();  // Prevent default form behavior
            
                            const orderItemId = button.getAttribute('data-order-item-id');  // Get order item ID
            
                            // Show confirmation SweetAlert
                            Swal.fire({
                                title: 'Confirm Return',
                                text: 'Are you sure you want to return this product?',
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Yes, return it!',
                                cancelButtonText: 'No, cancel!'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    // Show reason input SweetAlert
                                    Swal.fire({
                                        title: 'Reason for Return',
                                        html: `
                                            <p style="color:#fd4f4f;">Please select a reason:</p><br>
                                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                                <div>
                                                    <input type="radio" id="wrong-item" name="reason" value="Product is not the same">
                                                    <label for="wrong-item">Product is not the same</label>
                                                </div>
                                                <div>
                                                    <input type="radio" id="defective" name="reason" value="Product is defective">
                                                    <label for="defective">Product is defective</label>
                                                </div>
                                                <div>
                                                    <input type="radio" id="changed-mind" name="reason" value="Changed my mind">
                                                    <label for="changed-mind">Changed my mind</label>
                                                </div>
                                                <div>
                                                    <input type="radio" id="other" name="reason" value="Other">
                                                    <label for="other">Other:</label>
                                                    <input type="text" id="other-reason" placeholder="Enter your reason here" style="margin-left: 5px; padding: 5px; border-radius: 5px; border: 1px solid #ccc; width: 100%;">
                                                </div>
                                            </div>
                                        `,
                                        showCancelButton: true,
                                        confirmButtonText: 'Submit',
                                        cancelButtonText: 'Cancel',
                                        preConfirm: () => {
                                            const reasonInputs = document.getElementsByName('reason');
                                            let reasonSelected = false;
                                            let reasonText = '';
            
                                            // Check if a reason is selected
                                            for (const input of reasonInputs) {
                                                if (input.checked) {
                                                    reasonSelected = true;
                                                    reasonText = input.value;
            
                                                    // If 'Other' is selected, validate the text input
                                                    if (input.id === 'other') {
                                                        const customReason = document.getElementById('other-reason').value.trim();
                                                        if (!customReason) {
                                                            Swal.showValidationMessage('Please enter a reason for the return.');
                                                            return false;  // Prevent submission
                                                        }
                                                        reasonText = customReason;  // Use the custom reason provided by the user
                                                    }
                                                    break;
                                                }
                                            }
            
                                            // If no reason is selected
                                            if (!reasonSelected) {
                                                Swal.showValidationMessage('You need to select a reason for the return.');
                                                return false;  // Prevent submission
                                            }
            
                                            return { reason: reasonText };  // Return the reason for the fetch request
                                        }
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            const reason = result.value.reason;  // Get the reason provided by the user
            
                                            // Dynamically construct the URL using Django reverse URL pattern
                                            const requestReturnUrl = "{% url 'user_side:request-return' 0 %}".replace('0', orderItemId);
            
                                            // Make the fetch request to the server to update the return status
                                            fetch(requestReturnUrl, {
                                                method: 'POST',  // Use POST method
                                                headers: {
                                                    'Content-Type': 'application/json',  // Set the content type as JSON
                                                    'X-CSRFToken': '{{ csrf_token }}',  // Send CSRF token for security
                                                },
                                                body: JSON.stringify({ status: 'Return Requested', reason: reason })  // Send status and reason as payload
                                            })
                                            .then(response => {
                                                if (!response.ok) {
                                                    throw new Error('Network response was not ok');
                                                }
                                                return response.json();  // Parse JSON response
                                            })
                                            .then(data => {
                                                if (data.success) {
                                                    // Show success message using SweetAlert
                                                    Swal.fire({
                                                        title: 'Success!',
                                                        text: 'Return request has been submitted.We will reach out you with in few days...',
                                                        icon: 'success',
                                                        confirmButtonText: 'OK'
                                                    });
            
                                                    // Dynamically change the button's color and status to indicate return request
                                                    button.style.backgroundColor = 'gray';  // Change color to gray
                                                    button.textContent = 'Requested';  // Change button text
                                                    button.style.color = 'white'; 
                                                    button.disabled = true;  // Disable the button to prevent multiple clicks
                                                    button.style.cursor = 'default'; 
                                                } else {
                                                    // Show error message using SweetAlert
                                                    Swal.fire({
                                                        title: 'Error!',
                                                        text: 'Could not process the return request.',
                                                        icon: 'error',
                                                        confirmButtonText: 'OK'
                                                    });
                                                }
                                            })
                                            .catch(error => {
                                                console.error('Error:', error);
                                                // Show error message using SweetAlert
                                                Swal.fire({
                                                    title: 'Oops!',
                                                    text: 'An error occurred while requesting the return.',
                                                    icon: 'error',
                                                    confirmButtonText: 'OK'
                                                });
                                            });
                                        }
                                    });
                                }
                            });
                        });
                    });
                });
            </script>
            

            
            <style>
            @media screen and (max-width: 767px) {
                .responsive-table thead {
                    display: none;
                }
                .responsive-table, .responsive-table tbody, .responsive-table tr, .responsive-table td {
                    display: block;
                    width: 100%;
                }
                .responsive-table tr {
                    margin-bottom: 15px;
                }
                .responsive-table td {
                    text-align: right;
                    padding-left: 50%;
                    position: relative;
                }
                .responsive-table td::before {
                    content: attr(data-label);
                    position: absolute;
                    left: 6px;
                    width: 45%;
                    padding-right: 10px;
                    white-space: nowrap;
                    text-align: left;
                    font-weight: bold;
                }
                .responsive-table td img {
                    max-width: 100%;
                    height: auto;
                }
            }
            </style>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>      
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cancelButtons = document.querySelectorAll('.cancel-order-item-btn');
    
        cancelButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault(); // Prevent default button behavior
                const cancelUrl = this.getAttribute('data-url');
    
                // Show SweetAlert confirmation with CAPTCHA
                Swal.fire({
                    title: 'Are you sure to cancell this product ?',
                    text: "Please confirm the cancellation!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Cancel!',
                    html: `
                    <div>Enter CAPTCHA to confirm:</div>
                    <div id="captcha-container" style="text-align: center; margin-bottom: 10px;">
                        <img src="" id="captcha-image" alt="CAPTCHA Image" 
                             style="display: block; max-width: 100%; height: auto; margin: 0 auto;">
                    </div>
                    <input type="text" id="captcha-input" placeholder="Enter CAPTCHA" class="swal2-input">
                     `,
                    didOpen: () => {
                        // Load CAPTCHA from Django when the modal opens
                        loadCaptcha();
                    },
                    preConfirm: () => {
                        // Get the entered CAPTCHA value
                        const captchaResponse = document.getElementById('captcha-input').value;
                        const captchaKey = document.getElementById('captcha-container').getAttribute('data-captcha-key');

                        if (!captchaResponse) {
                            Swal.showValidationMessage('Please enter the CAPTCHA');
                            return false;
                        }
    
                        // Return the CAPTCHA input value to the `then` part of the promise
                        return { captchaResponse: captchaResponse,captchaKey: captchaKey };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Send cancellation request along with CAPTCHA to the server
                        fetch(cancelUrl, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                'captcha_response': result.value.captchaResponse,  // Send the CAPTCHA response
                                'captcha_key': result.value.captchaKey  
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                Swal.fire('Error', data.error, 'error');
                            } else {
                                Swal.fire('Success', data.message, 'success');
                                button.setAttribute('disabled', 'true');
                                button.innerText = 'Cancelled';
                                button.style.backgroundColor = 'gray';
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    }
                });
            });
    
            // Function to load the CAPTCHA from Django
            function loadCaptcha() {
                fetch("{% url 'wallet:captcha-image-url' %}")
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('captcha-image').src = data.captcha_image_url; // Set CAPTCHA image source
                        document.getElementById('captcha-container').setAttribute('data-captcha-key', data.captcha_key);
                    });
            }
        });
    });

     // custom tooltip
     $(document).ready(function(){
            $('[data-toggle="tooltip"]').tooltip({
                delay: { "show": 500, "hide": 100 },  // Delay before showing and hiding the tooltip
                placement: 'top'  // Placement can be adjusted as needed
            });
        });
    </script>
        
    <script>
    {% for message in messages %}
        swal.fire({
            icon:"{{message.tags}}",
            title:"{{message}}",
            text:"{{message.tags}}",
        })
    {% endfor %}
    </script>

    <!-- Plugins JS File -->
    <script src="{% static 'assets/js/jquery.min.js' %}"></script>
    <script src="{% static 'assets/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'assets/js/jquery.hoverIntent.min.js' %}"></script>
    <script src="{% static 'assets/js/jquery.waypoints.min.js' %}"></script>
    <script src="{% static 'assets/js/superfish.min.js' %}"></script>
    <script src="{% static 'assets/js/owl.carousel.min.js' %}"></script>
    

    <!-- Main JS File -->
    <script src="{% static 'assets/js/main.js' %}"></script>
   

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>

    <!-- for the sweet alert  -->
 
    
<script>
	// Function to update cart count
	function updateCartCount() {
		fetch('{% url "cart:cart-count" %}', {
			method: 'GET',
			headers: {
				'X-Requested-With': 'XMLHttpRequest',
				'X-CSRFToken': '{{ csrf_token }}'
			}
		})
		.then(response => response.json())
		.then(data => {
			if (data.status === 'success') {
				document.querySelector('.cart-count').textContent = data.count;
			} else {
				console.error('Failed to fetch cart count:', data.message);
			}
		})
		.catch(error => console.error('Error:', error));
	}

	// Call the updateCartCount function when the page loads
	document.addEventListener('DOMContentLoaded', updateCartCount);

</script>
<script>
function outOfStockAlert(productName) {
    Swal.fire({
        toast: true,
        position: 'top-end',
        icon: 'error',
        title: `Cannot Complete Payment`,
        html: `
            <div style="font-size: 14px; line-height: 1.5;">
                Payment for <strong>${productName}</strong> cannot be completed because this item is out of stock.<br><br>
                Please <strong>contact support</strong> for further assistance.
            </div>
        `,
        showConfirmButton: true,
        confirmButtonText: 'OK',
        confirmButtonColor: '#d33',
        customClass: {
            confirmButton: 'swal2-confirm-large'
        },
        width: '400px',
        timer: 30000,
        timerProgressBar: true,
    });
}
</script>

<style>
.swal2-confirm-large {
    font-size: 12px !important;
    padding: 5px 25px !important;
}
</style>



</body>


<!-- molla/dashboard.html  22 Nov 2019 10:03:13 GMT -->
</html>

{% endblock %}

