{% extends 'partials/base.html' %}
{% block content %}
{% load static %}
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert/dist/sweetalert.min.css">
</head>
<body>
        <main class="main">
            <div class="intro-section pt-lg-2">
               
                <div class="container">
                    <div style="margin-bottom:20px;">
                        {% block user-messages%}
                        {% include 'partials/user-message.html' %}
                        {% endblock %}
                    </div>
                   
                    <div class="row">
                        <div class="col-md-12 col-lg-6" >
                            <div class="banner banner-big banner-overlay">
                                <a href="#">
                                    <img src="{% static 'assets/images/cycle-home-1.png' %}" alt="Banner">
                                </a>

                                <div class="banner-content">
                                    <h4 class="banner-subtitle text-white"><a href="#">Your Guide To The World</a></h4><!-- End .banner-subtitle -->
                                    <h2 class="banner-title text-white"><a href="#">Must-Read <br>Travel Books</a></h2><!-- End .banner-title -->
                                    <a href="#" class="btn btn-outline-white-3 banner-link">Find out more<i class="icon-long-arrow-right"></i></a>
                                </div><!-- End .banner-content -->
                            </div><!-- End .banner -->
                        </div><!-- End .col-lg-6 -->
                        <div class="col-sm-6 col-lg-3">
                            <div class="banner banner-overlay">
                                <a href="#">
                                    <img src="{% static 'assets/images/cycle-home2.png' %}" alt="Banner">
                                </a>

                                <div class="banner-content banner-content-stretch">
                                    <h4 class="banner-subtitle text-white"><a href="#">New This Week</a></h4><!-- End .banner-subtitle -->
                                    <h3 class="banner-title text-white"><a href="#">Discover Our <br>Best Romance <br>Books</a></h3><!-- End .banner-title -->
                                    <a href="#" class="btn btn-outline-white-3 banner-link">Discover Now<i class="icon-long-arrow-right"></i></a>
                                </div><!-- End .banner-content -->
                            </div><!-- End .banner -->
                        </div><!-- End .col-lg-3 -->

                        <div class="col-sm-6 col-lg-3">
                            <div class="banner banner-small banner-overlay">
                                <a href="#">
                                    <img src="{% static 'assets/images/cycle-home-3.png' %}" alt="Banner">
                                </a>

                                <div class="banner-content">
                                    <h4 class="banner-subtitle text-white d-lg-none d-xl-block"><a href="#">Deal Of The Day</a></h4><!-- End .banner-subtitle -->
                                    <h3 class="banner-title text-white"><a href="#">20% Off Use <br>Code: <span>mybook</span></a></h3><!-- End .banner-title -->
                                    <a href="#" class="btn btn-outline-white-3 banner-link">Shop Now<i class="icon-long-arrow-right"></i></a>
                                </div><!-- End .banner-content -->
                            </div><!-- End .banner -->

                            <div class="banner banner-small banner-overlay">
                                <a href="#">
                                    <img src="{% static 'assets/images/cycle-home-4.png' %}" alt="Banner">
                                </a>

                                <div class="banner-content">
                                    <h4 class="banner-subtitle text-white d-lg-none d-xl-block"><a href="#">New Arrivals</a></h4><!-- End .banner-subtitle -->
                                    <h3 class="banner-title text-white"><a href="#">Business <br>& Economics</a></h3><!-- End .banner-title -->
                                    <a href="#" class="btn btn-outline-white-3 banner-link">Discover Now<i class="icon-long-arrow-right"></i></a>
                                </div><!-- End .banner-content -->
                            </div><!-- End .banner -->
                        </div><!-- End .col-lg-3 -->
                    </div><!-- End .row -->
                </div><!-- End .container -->

                <div class="icon-boxes-container bg-transparent">
                    <div class="container">
                        <div class="row">
                            <div class="col-sm-6 col-lg-3">
                                <div class="icon-box icon-box-side">
                                    <span class="icon-box-icon">
                                        <i class="icon-truck"></i>
                                    </span>
                                    <div class="icon-box-content">
                                        <h3 class="icon-box-title">Payment & Delivery</h3><!-- End .icon-box-title -->
                                        <p>Free shipping for orders over $50</p>
                                    </div><!-- End .icon-box-content -->
                                </div><!-- End .icon-box -->
                            </div><!-- End .col-sm-6 col-lg-3 -->

                            <div class="col-sm-6 col-lg-3">
                                <div class="icon-box icon-box-side">
                                    <span class="icon-box-icon">
                                        <i class="icon-rotate-left"></i>
                                    </span>

                                    <div class="icon-box-content">
                                        <h3 class="icon-box-title">Return & Refund</h3><!-- End .icon-box-title -->
                                        <p>Free 100% money back guarantee</p>
                                    </div><!-- End .icon-box-content -->
                                </div><!-- End .icon-box -->
                            </div><!-- End .col-sm-6 col-lg-3 -->

                            <div class="col-sm-6 col-lg-3">
                                <div class="icon-box icon-box-side">
                                    <span class="icon-box-icon">
                                        <i class="icon-life-ring"></i>
                                    </span>

                                    <div class="icon-box-content">
                                        <h3 class="icon-box-title">Quality Support</h3><!-- End .icon-box-title -->
                                        <p>Alway online feedback 24/7</p>
                                    </div><!-- End .icon-box-content -->
                                </div><!-- End .icon-box -->
                            </div><!-- End .col-sm-6 col-lg-3 -->

                            <div class="col-sm-6 col-lg-3">
                                <div class="icon-box icon-box-side">
                                    <span class="icon-box-icon">
                                        <i class="icon-envelope"></i>
                                    </span>

                                    <div class="icon-box-content">
                                        <h3 class="icon-box-title">Join Our Newsletter</h3><!-- End .icon-box-title -->
                                        <p>10% off by subscribing to our newsletter</p>
                                    </div><!-- End .icon-box-content -->
                                </div><!-- End .icon-box -->
                            </div><!-- End .col-sm-6 col-lg-3 -->
                        </div><!-- End .row -->
                    </div><!-- End .container -->
                </div><!-- End .icon-boxes-container -->
            </div><!-- End .intro-section -->

            <div class="bestseller-products bg-light pt-5 pb-5 mb-5">
                <div class="block">
                    <div class="block-wrapper ">
                        <div class="container">
                            <div class="heading heading-flex">
                                <div class="heading-left">
                                    <h2 class="title">Bestsellers</h2><!-- End .title -->
                                </div><!-- End .heading-left -->

                                <div class="heading-right">
                                    <a href="{% url 'core:category-filter'%}" class="title-link">View more Products <i class="icon-long-arrow-right"></i></a>
                                </div><!-- End .heading-right -->
                            </div><!-- End .header-flex -->

                            <div class="owl-carousel carousel-equal-height owl-simple" data-toggle="owl" 
                                data-owl-options='{
                                    "nav": false, 
                                    "dots": true,
                                    "margin": 20,
                                    "loop": false,
                                    "responsive": {
                                        "0": {
                                            "items":2
                                        },
                                        "480": {
                                            "items":2
                                        },
                                        "768": {
                                            "items":3
                                        },
                                        "992": {
                                            "items":4
                                        },
                                        "1440": {
                                            "items":5
                                        }
                                    }
                                }'>

                                {% for product_variant in product_variants %}
                                <div class="product">
                                    <span class="product-label label-sale">Sale</span>
                                    <figure class="product-media">
                                        {% if product_variant.image1 %}
                                        <a href="{% url 'products:single-product-view' product_variant.id %}">
                                            <img src="{{ product_variant.image1.url }}" alt="{{ product_variant.product.name }}" class="product-image">
                                        </a>
                                        {% else %}
                                            <img src="" alt="No image available" class="product-image">
                                        {% endif %}
                                    </figure>
                                    
                                    <div class="product-body">
                                        <div class="product-cat" style="color:rgb(115, 114, 114)">
                                            From : <span>{{ product_variant.product.brand }}</span>
                                        </div>
                                        <div class="product-cat" style="color:rgb(115, 114, 114)">
                                            Size : <span>{{ product_variant.size }}</span>
                                        </div>
                                        <h3 class="product-title"><a href="{% url 'products:single-product-view' product_variant.id %}">{{ product_variant.product.name }}</a></h3>
                                        <div class="product-price">
                                            <span class="new-price">₹  {{ product_variant.price }}</span>
                                           
                                        </div>
                                        <div class="product-footer">
                                            <div class="ratings-container">
                                                <div class="ratings">
                                                    <div class="ratings-val" style="width: 80%;"></div>
                                                </div>
                                                <span class="ratings-text">( 10 Reviews )</span>
                                            </div>
                                            <div class="product-action">
                                                <button class="btn-product btn-cart" data-product-id="{{ product_variant.id }}" onclick="addToCart(this)">Add to Cart</button>
                                                <a href="#" class="btn-product btn-wishlist"><span>Add to Wishlist</span></a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}


                            </div><!-- End .owl-carousel -->
                        </div><!-- End .container -->
                    </div><!-- End .block-wrapper -->
                </div><!-- End .block -->
            </div><!-- End .bg-light pt-4 pb-4 -->

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script>
            // Function to update cart count
            function updateCartCount() {
                fetch('{% url "cart:cart-count" %}', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.querySelector('.cart-count').textContent = data.count;
                    } else {
                        console.error('Failed to fetch cart count:', data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
            }

            // Call the updateCartCount function when the page loads
            document.addEventListener('DOMContentLoaded', updateCartCount);

        </script>

        <script>
            // Common SweetAlert function
            function showAlert(title, message, icon = 'info', buttonText = 'OK') {
                swal.fire({
                    title: title,
                    text: message,
                    icon: icon, // can be 'success', 'error', 'warning', or 'info'
                    confirmButtonText: buttonText,
                });
            }

            // Function to update the button state and style
            function updateButtonState(button, isAdded) {
                if (isAdded) {
                    button.textContent = 'Remove from Cart'; // Change text to "Remove from Cart"
                    button.style.backgroundColor = 'grey'; // Change button color to grey
                    button.style.color = 'white'; // Set text color to white for better contrast
                } else {
                    button.textContent = 'Add to Cart';
                    button.style.backgroundColor = ''; // Reset to default color
                    button.style.color = ''; // Reset text color
                }
            }
            function addToCart(button){
                const productId=button.getAttribute('data-product-id');

                // Check if button is already in "Added to Cart" state
                const isAlreadyAdded = button.textContent === 'Remove from Cart';

                // Toggle state based on the current state
                const action = isAlreadyAdded ? 'remove' : 'add';

                fetch('{% url "cart:add-to-cart" %}',{
                    method:'POST',
                    headers:{
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams({
                        'product_variant_id': productId,
                        'action': action 
                    })
                })
                .then(response => {
                    if (response.status === 401) {
                        // User is not logged in
                        return response.json().then(data => {
                            showAlert('Login Required', data.message, 'warning', 'OK');
                            throw new Error('Unauthorized'); // Stop further processing
                        });
                    } else if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error('Unexpected response');
                    }
                })
            
                .then(data => {
                    if (data.status === 'success') {
                        updateButtonState(button, action === 'add');
                        showAlert('Success!', data.message, 'success','OK'); // Show success message
                        updateCartCount();
                    } else {
                        showAlert('Notice', data.message || 'An error occurred. Please try again.', 'info','OK'); 
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (error.message !== 'Unauthorized') {
                        showAlert('Error', 'An error occurred. Please try again.', 'error', 'OK');
                    }
                });
            }
        </script>
</body>
{% endblock content %}
          